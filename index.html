<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<title>Extending Umbraco Forms</title>

	<link rel="stylesheet" href="dist/reset.css">
	<link rel="stylesheet" href="dist/reveal.css">
	<link rel="stylesheet" href="dist/theme/truelime.css" />

	<!-- Theme used for syntax highlighted code -->
	<link rel="stylesheet" href="plugin/highlight/monokai.css">
</head>

<body>
	<div class="reveal">
		<div class="slides">
			<section class="full-screen-slide" data-background-color="rgb(136,0,78)">
				<h1 class="r-fit-text">Extending<br /> Umbraco Forms</h1>
			</section>

			<section>
				<h2>Introduction</h2>
				<ul>
					<li>Dave Woestenborghs</li>
					<li>Work at <a href="https://truelime.nl/">Truelime</a></li>
					<li>Umbraco MVP (9x)</li>
					<li>Working with Umbraco since 2008</li>
					<li>Part of the 24 days in Umbraco team</li>
				</ul>
			</section>

			<section data-auto-animate>
				<h2>Umbraco Forms</h2>
				<p>First released around 2010 as <a
						href="https://our.umbraco.com/packages/umbraco-pro/contour/">Contour</a></p>
				<p class="fragment">Commercial add-on developed by Umbraco HQ</p>
				<p class="fragment">Rebranded to <a href="https://marketplace.umbraco.com/package/umbraco.forms">Umbraco
						Forms</a> around 2016</p>
			</section>

			<section data-auto-animate>
				<h2>Umbraco Forms</h2>
				<p>Allows website editors and developers to create and manage forms directly within the Umbraco
					environment, without needing to write custom code.</p>
			</section>

			<section data-auto-animate>
				<h2>Umbraco Forms</h2>
				<p>But it can be customized and extended.</p>
			</section>

			<section class="full-screen-slide" data-background-color="#e33f00">
				<h1 class="r-fit-text">Changing<br> default behavior</h1>
			</section>

			<section data-auto-animate>
				<h2>Form design</h2>
				<p>Configure default values for design and behavoir <a
						href="https://docs.umbraco.com/umbraco-forms/v/13.forms.latest-lts/developer/configuration#form-design-configuration">
						settings</a></p>

			</section>

			<section data-auto-animate>
				<h2>Form design</h2>
				<pre>
					<code data-trim data-noescape class="language-json">
						"Umbraco": {
							"Forms": {
								"FormDesign": {
									"MaxNumberOfColumnsInFormGroup": 12,
									"DefaultTheme": "default",
									"Defaults": {
										"DisableStylesheet": true,
										"AutocompleteAttribute": "off",
										"Indicator": "*",
										"MarkFieldsIndicator": "MarkMandatoryFields",
										"DaysToRetainApprovedRecordsFor": 90,
										"DaysToRetainRejectedRecordsFor": 90,
										"DaysToRetainSubmittedRecordsFor": 90
									}									
								}								
							}
						}
					</code>
				</pre>
			</section>

			<section data-auto-animate data-auto-animate-restart>
				<h2>Settings customization</h2>
				<p>Customize <a
						href="https://docs.umbraco.com/umbraco-forms/v/13.forms.latest-lts/developer/configuration#settingscustomization">settings</a>
					for <a
						href="https://docs.umbraco.com/umbraco-forms/v/13.forms.latest-lts/developer/configuration/type-details">provider
						types</a>
					<br /> (fields, workflows,..)
				</p>
			</section>

			<section data-auto-animate>
				<h2>Settings customization</h2>
				<p>Provide a default value</p>
				<p class="fragment">Read only mode</p>
				<p class="fragment">Hide the setting</p>
			</section>

			<section data-auto-animate>
				<h2>Settings customization</h2>
				<pre>
					<code data-trim data-noescape class="language-json">
						"Umbraco": {
							"Forms": {
								"FormDesign": {									
									"SettingsCustomization": {
										"FieldTypes": {
											"shortAnswer": {
												"AutocompleteAttribute": {
													"IsHidden": true,
													"DefaultValue": "off"
												}
											}
										}
									}
								}
							}
						}
					</code>
				</pre>
			</section>

			<section data-auto-animate data-auto-animate-restart>
				<h2>Default fields & workflows</h2>
				<p>Out of the box when creating a new form a consent field and a e-mail workflow are added, <br>but this can be changed</p>				
			</section>

			<section data-auto-animate>
				<h2>Default fields & workflows</h2>
				<p>For fields replace the implementation of the <a href="https://docs.umbraco.com/umbraco-forms/v/13.forms.latest-lts/developer/extending/customize-default-workflows#example-providing-a-custom-apply-fields-behavior">IApplyDefaultFieldsBehavior</a> interface</p>								
			</section>

			<section data-auto-animate>
				<h2>Default fields & workflows</h2>
				<p>For workflows replace the implementation of the <a href="https://docs.umbraco.com/umbraco-forms/v/13.forms.latest-lts/developer/extending/customize-default-workflows#example-providing-a-custom-apply-workflows-behavior">IApplyDefaultWorkflowsBehavior</a> interface</p>								
			</section>

			<section data-auto-animate>
				<h2>Default fields & workflows</h2>
				<pre>
					<code  data-line-numbers="1-2|14-15|16-22|24-28|30-39|42-44" data-trim data-noescape class="language-csharp">
public class ApplyDefaultFieldsBehavior : IApplyDefaultFieldsBehavior
{
    private readonly FormDesignSettings _formDesignSettings;
    private readonly FieldCollection _fieldCollection;

    public ApplyDefaultFieldsBehavior(
        IOptions<FormDesignSettings> formDesignSettings,
        FieldCollection fieldCollection)
    {
        this._formDesignSettings = formDesignSettings.Value;
        this._fieldCollection = fieldCollection;
    }

    public void ApplyDefaultFields(FormDesign form)
    {
        Page page = new Page();
        form.Pages.Add(page);
        FieldSet fieldSet = new FieldSet()
        {
            Id = Guid.NewGuid()
        };
        page.FieldSets.Add(fieldSet);

        FieldsetContainer container = new FieldsetContainer()
        {
            Width = 12
        };
        fieldSet.Containers.Add(container);

        var firstNameField = new Field
        {
            Alias = "firstName",
            Id = Guid.NewGuid(),
            FieldTypeId = Guid.Parse(Umbraco.Forms.Core.Constants.FieldTypes.Textfield),
            Mandatory = true,
            Caption = "First name"
        };

        container.Fields.Add(firstNameField);


        if (this._formDesignSettings.DisableAutomaticAdditionOfDataConsentField)
            return;
        container.AddDataConsentField(this._formDesignSettings, this._fieldCollection);
    }
}
					</code>
				</pre>								
			</section>

			<section data-auto-animate>
				<h2>Default fields & workflows</h2>
				<pre>
					<code  data-line-numbers="" data-trim data-noescape class="language-csharp">
						<script type="text/template">
							public class DefaultBehaviorComposer : IComposer
							{
								public void Compose(IUmbracoBuilder builder)
								{
									builder.Services.AddUnique<IApplyDefaultFieldsBehavior, ApplyDefaultFieldsBehavior>();
								}
							}
						</script>
					</code>
				</pre>								
			</section>

			<section data-background-video="video/default-fields.mp4" data-background-size="contain" class="full-screen-slide"></section>

			<section data-auto-animate>
				<h2>Provider types</h2>
				<p>Out of the box all provider based types are  available <br>
					(fields, workflows, etc..) </p>
			</section>

			<section data-auto-animate>
				<h2>Provider types</h2>
				<img class="r-stretch" src="img/workflows-before.png" />				
			</section>

			<section data-auto-animate>
				<h2>Provider types</h2>
				<p>Remove the ones you don't need</p>
			</section>

			<section data-auto-animate>
				<h2>Provider types</h2>
				<pre>
					<code  data-line-numbers="" data-trim data-noescape class="language-csharp">
						<script type="text/template">
public class ExcludeWorkflowTypesComposer : IComposer
{
	public void Compose(IUmbracoBuilder builder)
	{
		builder.FormsWorkflows()
			.Exclude<Slack>()
			.Exclude<SlackV2>()
			.Exclude<SendXsltEmail>()
			.Exclude<SaveAsUmbracoNode>()
			.Exclude<SaveAsFile>()
			.Exclude<PostAsXml>()
			.Exclude<PostToUrl>()
			.Exclude<SendEmail>();
	}
}
						</script>
					</code>
				</pre>								
			</section>

			<section data-auto-animate>
				<h2>Provider types</h2>
				<img class="r-stretch" src="img/workflows-after.png" />				
			</section>

			<section class="full-screen-slide" data-background-color="#db0967">
				<h1 class="r-fit-text">Form validation</h1>
			</section>

			<section data-auto-animate>
				<h2>Form validation</h2>
				<p>Fields can be marked as mandatory</p>
				<p class="fragment">A regular expression can be applied for format validation</p>
				<p class="fragment">Validation happens client and server side.</p>				
			</section>
			<section data-auto-animate>
				<h2>Form validation</h2>
				<p>Regular expression can be selected from a predefined list or entered manually</p>
				<img class="r-stretch" src="img/validation-before.png" />
			</section>

			<section data-auto-animate data-auto-animate-restart="">
				<h2>Custom validation patterns</h2>
				<p>The predefined list can be extended with additional <a href="https://docs.umbraco.com/umbraco-forms/v/13.forms.latest-lts/developer/extending/adding-a-validation-pattern">validation patterns</a>
				by registering a class that implements the IValidationPattern interface</p>							
			</section>

			<section data-auto-animate>
				<h2>Custom validation patterns</h2>
				<pre>
					<code  data-line-numbers="" data-trim data-noescape class="language-csharp">
						<script type="text/template">
							public class DutchIbanPattern : IValidationPattern
							{
								public string Alias => "dutchIbanPattern";
								// as an alternative to providing a name, a translation key can be provided.
								// This will be used to look-up the name in the correct language for the backoffice user.
								public string LabelKey => string.Empty;
								public string Name => "Dutch IBAN Number";
								public string Pattern => "^NL[0-9]{2}[A-Z]{4}[0-9]{10}$";
								public bool ReadOnly => true;
							}
						</script>
					</code>
				</pre>								
			</section>

			<section data-auto-animate>
				<h2>Custom validation patterns</h2>
				<pre>
					<code  data-line-numbers="" data-trim data-noescape class="language-csharp">
						<script type="text/template">
public class AddValidationPatternsComposer : IComposer
{
	public void Compose(IUmbracoBuilder builder)
	{
		builder.FormsValidationPatterns().Append<DutchIbanPattern>();
	}
}
						</script>
					</code>
				</pre>								
			</section>

			<section data-auto-animate>
				<h2>Custom validation patterns</h2>				
				<img class="r-stretch" src="img/validation-after.png" />
			</section>

			<section data-auto-animate data-auto-animate-restart>
				<h2>Additional validation</h2>
				<p>In many cases mandatory and pattern validation is not sufficient</p>
				<p class="fragment">The IBAN pattern validation will allow invalid numbers. </p>
				<p class="fragment">At least a checksum validation is needed.</p>
			</section>

			<section data-auto-animate>
				<h2>Additional validation</h2>
				<p>Umbraco Forms publishes a <a href="https://docs.umbraco.com/umbraco-forms/v/13.forms.latest-lts/developer/extending/adding-an-event-handler#form-validation-notification">FormValidateNotification</a>
					before a form submission is being saved.
				</p>
			</section>
			
			<section data-auto-animate>
				<h2>Additional validation</h2>
				<pre>
					<code  data-line-numbers="1-2|10-11|17-21|23-29|31-46" data-trim data-noescape class="language-csharp">
						<script type="text/template">
							public class IbanFormValidationHandler : INotificationHandler<FormValidateNotification>
								{
									private readonly IIbanValidator ibanValidator;
								
									public IbanFormValidationHandler(IIbanValidator ibanValidator)
									{
										this.ibanValidator = ibanValidator;
									}
								
									public void Handle(FormValidateNotification notification)
									{
										if (notification.ModelState.IsValid == false)
										{
											return;
										}
								
										// check if it is the form we want to validate
										if (notification.Form.Id.ToString().InvariantEquals("19e1b89c-17b5-4a39-a691-6da11d04e18d") == false)
										{
											return;
										}
								
										// check if the iban field is present on the form
										var ibanField = notification.Form.AllFields.FirstOrDefault(x => x.Alias.ToLowerInvariant() == "iban");
								
										if (ibanField == null)
										{
											return;
										}
										
										// get value from the request
										var ibanValue = notification.Context.Request.Form[ibanField.Id.ToString()].ToString();
								
										if (string.IsNullOrWhiteSpace(ibanValue))
										{
											return;
										}
								
										var result = this.ibanValidator.Validate(ibanValue);
								
										if (result.IsValid)
										{
											return;
										}
								
										notification.ModelState.AddModelError(ibanField.Id.ToString(), "IBAN is not valid");
									}
								}
						</script>
					</code>
				</pre>								
			</section>

			<section data-auto-animate>
				<h2>Additional validation</h2>
				<pre>
					<code  data-line-numbers="" data-trim data-noescape class="language-csharp">
						<script type="text/template">
							public class FormValidationComposer : IComposer
							{
								public void Compose(IUmbracoBuilder builder)
								{
									builder.AddNotificationHandler<FormValidateNotification, IbanFormValidationHandler>();
								}
							}
						</script>
					</code>
				</pre>								
			</section>

			<section class="full-screen-slide" data-background-color="#8bb20d">
				<h1 class="r-fit-text">Provider types</h1>
			</section>

			<section>
				<h2>Provider types</h2>
				<p>Umbraco Forms can be extended with custom provider types</p>				
			</section>

			<section data-auto-animate>
				<h2>Custom field type</h2>
				<p>It is possible to extend Umbraco Forms with your own field types by registering a class that inherits FieldType</p>
			</section>

			<section data-auto-animate>
				<h2>Custom field type</h2>
				<pre>
					<code  data-line-numbers="1-2|5-16|18-21|24-48" data-trim data-noescape class="language-csharp">
						<script type="text/template">
public class DutchIbanField : Umbraco.Forms.Core.FieldType
{
    private static Regex DutchIbanRegex = new Regex("^NL[0-9]{2}[A-Z]{4}[0-9]{10}$", RegexOptions.Compiled);

    public DutchIbanField()
    {
        Id = new Guid("c47aab84-c726-4497-a786-76a0db5ec1ae");
        Name = "Dutch IBAN Field";
        Description = "Renders a Dutch IBAN input Field.";
        Icon = "icon-autofill";
        DataType = FieldDataType.String;
        SortOrder = 10;
        SupportsRegex = false;
        SupportsPreValues = false;
        FieldTypeViewName = "FieldType.DutchIbanField.cshtml";
    }

    public override string GetDesignView()
    {
        return "/App_Plugins/UmbracoForms/backoffice/Common/FieldTypes/textfield.html";
    }


    public override IEnumerable<string> ValidateField(Form form, Field field, IEnumerable<object> postedValues, HttpContext context,
        IPlaceholderParsingService placeholderParsingService, IFieldTypeStorage fieldTypeStorage)
    {
        var errors = new List<string>();
        var ibanValidator = new IbanValidator();

        foreach (var value in postedValues)
        {
            var stringValue = value?.ToString() ?? string.Empty;

            if (DutchIbanRegex.IsMatch(stringValue) == false)
            {
                errors.Add("Not a valid IBAN Number");
            }
            else if (ibanValidator.Validate(stringValue).IsValid == false)
            {
                {
                    errors.Add("Not a valid Dutch IBAN number");
                }
            }
        }

        return base.ValidateField(form, field, postedValues, context, placeholderParsingService, fieldTypeStorage, errors);

    }
						</script>
					</code>
				</pre>			
			</section>

			<section data-auto-animate>
				<h2>Custom field type</h2>
				<pre>
					<code  data-line-numbers="" data-trim data-noescape class="language-csharp">
						<script type="text/template">
public class AddCustomFieldsComposer : IComposer
{
	public void Compose(IUmbracoBuilder builder)
	{
		builder.FormsFields().Add<DutchIbanField>();
	}
}
						</script>
					</code>
				</pre>								
			</section>

			<section data-auto-animate>
				<h2>Custom field type</h2>
				<img class="r-stretch" src="img/field-types.png" />
			</section>

			<section data-auto-animate>
				<h2>Custom field type</h2>
				<p>Create a razor view with the name FieldType.DutchIbanField.cshtml in the folder <br> /Views/Partials/Forms/Themes/default/FieldTypes</p>
			</section>
	</div>

	<div id="tl-logo" class="hide-logo">
		<a href="https://www.truelime.nl/">
			<img src="img/logo.svg" width="200" />
		</a>
	</div>


	<script src="dist/reveal.js"></script>
	<script src="plugin/notes/notes.js"></script>
	<script src="plugin/markdown/markdown.js"></script>
	<script src="plugin/highlight/highlight.js"></script>
	<!-- <script src="plugin/highlight/cshtml-razor.min.js"></script> -->
	<script src="plugin/zoom/zoom.js"></script>
	<script>
		// More info about initialization & config:
		// - https://revealjs.com/initialization/
		// - https://revealjs.com/config/
		Reveal.initialize({
			hash: true,

			// Learn about plugins: https://revealjs.com/plugins/
			plugins: [RevealMarkdown, RevealHighlight, RevealNotes, RevealZoom],
			width: 1200,
			height: 700,
			transition: 'convex'
		});

		Reveal.on('slidechanged', function (event) {
			var logo = document.querySelector('#tl-logo');

			if (event.currentSlide.classList.contains('full-screen-slide')) {
				logo.classList.add('hide-logo');
			}
			else {
				logo.classList.remove('hide-logo');
			}
		});
	</script>
</body>

</html>